name: 'Chromatic'

on: push

jobs:
  chromatic:
    name: Run Chromatic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'

      - name: Configure npm for native dependencies
        run: |
          # Create .npmrc file with appropriate settings
          echo "legacy-peer-deps=true" > .npmrc
          echo "node-linker=hoisted" >> .npmrc

          # Delete any existing lockfile to ensure clean resolution
          rm -f package-lock.json

      - name: Install dependencies with platform binaries
        run: |
          # Fresh install with forced resolution
          npm install --force

          # Explicitly install platform-specific binaries
          npm install --no-save @rollup/rollup-linux-x64-gnu
          npm install --no-save @swc/core-linux-x64-gnu

          # Verify installation
          ls -la node_modules/@rollup/rollup-linux-x64-gnu || echo "Rollup binary not installed"
          ls -la node_modules/@swc/core-linux-x64-gnu || echo "SWC binary not installed"

          # Force rebuild of native modules
          npm rebuild

      - name: Pre-build Storybook
        run: |
          # Create a temporary build directory
          mkdir -p storybook-static

          # Build Storybook directly with increased memory limit
          NODE_OPTIONS="--max-old-space-size=4096" npx storybook build --output-dir=./storybook-static

      - name: Run Chromatic with pre-built Storybook
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          storybookBuildDir: ./storybook-static
          skip: ${{ github.actor == 'dependabot[bot]' }}
